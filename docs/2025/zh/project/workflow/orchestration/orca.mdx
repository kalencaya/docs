# Orca

[spinnaker](https://spinnaker.io/) 是一个多云交付系统，即 CI/CD 中的 CD 部分，定位类似于 [KubeVela](https://kubevela.io/zh/)。Spinnaker 源自于 Netflix，完全基于云服务，对接 aws 等云服务商，将应用部署到云服务中。和物理机类似的“包年包月”不同，Spinnaker 支持的是按量付费和动态伸缩，追求极致的弹性。Spinnaker 极其强大的一点在于多云交付，避免应用因为单一云服务故障导致应用不可用。

Spinnaker 采用[微服务架构](https://spinnaker.io/docs/reference/architecture/microservices-overview/)，[orca](https://github.com/spinnaker/orca) 是流程引擎。Spinnaker 的发布流水线由一个个 stage 组成，[deck](https://github.com/spinnaker/deck) 提供可视化界面将 stage 串联起来组成 pipeline。Orca 则具体执行 pipeline。在 Orca 中，pipeline 表示串行之行的 stages，还可以支持并行的orchestration。

参考链接：

* [spinnaker](https://spinnaker.io/)。
  * [application deployment](https://spinnaker.io/docs/concepts/#application-deployment)
  * [pipelines](https://spinnaker.io/docs/concepts/pipelines/)
  * [create a pipeline](https://spinnaker.io/docs/guides/user/pipeline/managing-pipelines/#create-a-pipeline)
  * [Pipeline Templates](https://spinnaker.io/docs/reference/pipeline/templates/)
  * [Plugin User Guide](https://spinnaker.io/docs/guides/user/plugins-users/)
  * [Test a Pipeline Stage Plugin](https://spinnaker.io/docs/guides/developer/plugin-creator/testing/plugin-deck-test/)
  * [Custom Job Stages](https://spinnaker.io/docs/guides/operator/custom-job-stages/)
  * [Custom Webhook Stages](https://spinnaker.io/docs/guides/operator/custom-webhook-stages/)
  * [Hiding Stages](https://spinnaker.io/docs/guides/operator/hiding-stages/)
  * [Writing a New Stage](https://spinnaker.io/docs/guides/developer/extending/new-stage/)
  * [Set up Orca to use SQL](https://spinnaker.io/docs/setup/productionize/persistence/orca-sql/)
  * [Orca: Redis to SQL Migration](https://spinnaker.io/docs/guides/operator/orca-redis-to-sql/)
  * [Horizontally Scale Spinnaker Services](https://spinnaker.io/docs/setup/productionize/scaling/horizontal-scaling/)
* [Spinnaker第七节—Orca代码详解](https://blog.csdn.net/yejingtao703/article/details/104246126)

## 原理介绍

Orca 将任务定义为 3 层：

* pipeline。`PipelineExecution`，有 2 种类型：`PIPELINE`、`ORCHESTRATION`。pipeline 由一系列的 stages 组成
* stage。`StageExecution`。stage 本身由一系列的 tasks 组成，tasks 之间组成一个 DAG
* task。`TaskExecution`。task 是最小粒度的划分，完成具体的任务

![pipelines.png](./images/orca/pipelines.png)

![pipeline-tasks.png](./images/orca/pipeline-tasks.png)

Orca 使用队列管理内部任务分发，队列实现为延迟队列：

* 可扩展性。Orca 节点为队列消费者，可方便扩展
* 容错。队列具有重试功能
* 易维护。通过定义良好的 `Message` 和 `Handler`，功能清晰

在存储上，Orca 提供了 2 种实现：Redis 和 MySQL

* 队列。同时支持 Redis 和 MySQL，推荐使用 Redis
* Orca。同时支持 Redis 和 MySQL，推荐使用 MySQL
